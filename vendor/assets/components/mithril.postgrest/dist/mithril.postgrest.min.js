/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license 
    Version: 1.0.2
*/
!function(a){"object"==typeof exports?a(require("mithril"),require("underscore"),require("node-localstorage")):a(window.m,window._,window.localStorage)}(function(a,b,c){var d={},e=function(a){return a?c.setItem("postgrest.token",a):c.getItem("postgrest.token")},f=function(a){return a.setRequestHeader("Authorization","Bearer "+e()),a};d.reset=function(){c.removeItem("postgrest.token")},d.paginationVM=function(c,d){var e=a.prop([]),f=d||"id.desc",g=a.prop({order:f}),h=a.prop(!1),i=a.prop(1),j=a.prop(),k=function(){var d=a.deferred(),f=function(a){if(!a||0===a.status)return JSON.stringify({hint:null,details:null,code:0,message:"Connection error"});var c=a.getResponseHeader("Content-Range");b.isString(c)&&c.split("/").length>1&&j(parseInt(c.split("/")[1]));try{return JSON.parse(a.responseText),a.responseText}catch(d){return JSON.stringify({hint:null,details:null,code:0,message:a.responseText})}};return h(!0),c(i(),g(),{background:!0,extract:f}).then(function(c){e(b.union(e(),c)),h(!1),d.resolve(e()),a.redraw()},function(b){h(!1),j(0),d.reject(b),a.redraw()}),d.promise},l=function(a){return g(b.extend({order:f},a)),e([]),i(1),k()},m=function(){return i(i()+1),k()};return{collection:e,firstPage:l,isLoading:h,nextPage:m,total:j}},d.filtersVM=function(c){var d=function(){var b=a.prop("");return b.toFilter=function(){return(b()||"").toString().trim()},b},e=b.reduce(c,function(a,b,c){return"between"===b?a[c]={lte:d(),gte:d()}:a[c]=d(),a},{order:a.prop()}),f=function(){return b.reduce(e,function(a,d,e){if("order"!==e){var f=c[e];if(b.isFunction(d)&&!d())return a;if("ilike"===f||"like"===f)a[e]=f+".*"+d.toFilter()+"*";else if("@@"===f)a[e]=f+"."+d.toFilter().replace(/\s+/g,"&");else if("between"===f){if(!d.lte.toFilter()&&!d.gte.toFilter())return a;a[e]=[],d.gte()&&a[e].push("gte."+d.gte.toFilter()),d.lte()&&a[e].push("lte."+d.lte.toFilter())}else a[e]=f+"."+d.toFilter()}return a},{})},g=function(){var a=function(){return e.order()&&b.reduce(e.order(),function(a,b,c){return a.push(c+"."+b),a},[]).join(",")},c=a()?{order:a()}:{};return b.extend({},c,f())};return b.extend({},e,{parameters:g,parametersWithoutOrder:f})},d.init=function(c,g){return d.onAuthFailure=a.prop(function(){}),d.request=function(d){return a.request(b.extend({},d,{url:c+d.url}))},d.model=function(c){var d=function(a,b){var c=function(){var c=(a-1)*b,d=c+b-1;return c+"-"+d};return function(a){a.setRequestHeader("Range-unit","items"),a.setRequestHeader("Range",c())}},e=a.prop(10),f={url:"/"+c},g=function(a,c,e,g){return b.extend({},g,f,{method:"GET",data:a,config:d(c,e)})},h=function(b,c){return c.url+="?"+a.route.buildQueryString(b),c},i=function(c){return a.postgrest.request(b.extend({},c,f,{method:"OPTIONS"}))},j=function(a){return function(c,d){return a(b.extend({},d,f,{method:"POST",data:c}))}},k=function(a){return function(c,d){return a(h(c,b.extend({},d,f,{method:"DELETE"})))}},l=function(a){return function(c,d,e){return a(h(c,b.extend({},e,f,{method:"PATCH",data:d})))}},m=function(a){return function(b,c,d){return a(g(c,b,e(),d))}},n=function(a){return function(b,c){return a(g(b,1,1,c))}};return{pageSize:e,getPageWithToken:m(a.postgrest.requestWithToken),getPage:m(a.postgrest.request),getRowWithToken:n(a.postgrest.requestWithToken),getRow:n(a.postgrest.request),patchWithToken:l(a.postgrest.requestWithToken),patch:l(a.postgrest.request),deleteWithToken:k(a.postgrest.requestWithToken),"delete":k(a.postgrest.request),postWithToken:j(a.postgrest.requestWithToken),post:j(a.postgrest.request),options:i}},d.requestWithToken=function(c){return a.postgrest.authenticate().then(function(){var d=b.isFunction(c.config)?b.compose(c.config,f):f;return a.postgrest.request(b.extend(c,{config:d}))})},d.authenticate=function(){var b=a.deferred();return e()?(b.resolve({token:e()}),b.promise):a.request(g).then(function(a){e(a.token)},d.onAuthFailure())},d},a.postgrest=d});